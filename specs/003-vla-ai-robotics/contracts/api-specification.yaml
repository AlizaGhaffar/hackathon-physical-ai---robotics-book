openapi: 3.0.3
info:
  title: Chapter 3 VLA (Vision-Language-Action) API
  description: |
    REST API for Chapter 3 AI-Robotics integration features.
    Provides endpoints for voice control, vision analysis, code generation, and capstone project management.
  version: 1.0.0
  contact:
    name: Physical AI Textbook
servers:
  - url: http://localhost:8000/api/v1
    description: Local development
  - url: https://api.physical-ai.example.com/api/v1
    description: Production (deploy target)

tags:
  - name: voice
    description: Voice command processing (Whisper API)
  - name: vision
    description: Scene understanding (GPT-4 Vision API)
  - name: robot
    description: Robot control and action execution
  - name: code
    description: AI-assisted code generation
  - name: capstone
    description: Capstone project management
  - name: playground
    description: LLM-robot experimentation playground

paths:
  /voice/transcribe:
    post:
      tags: [voice]
      summary: Transcribe voice command using Whisper API
      operationId: transcribeVoiceCommand
      description: |
        Accepts audio recording and returns transcribed text.
        Audio is processed through OpenAI Whisper API.
        Transcription is cached for 5 minutes.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [audio_file]
              properties:
                audio_file:
                  type: string
                  format: binary
                  description: WebM audio file (<5MB, 1-60 seconds)
                language:
                  type: string
                  enum: [en, ur, auto]
                  default: auto
                  description: Language hint (auto-detect if not specified)
      responses:
        '200':
          description: Transcription successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TranscriptionResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '413':
          description: Audio file too large (>5MB)
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalError'

  /vision/analyze:
    post:
      tags: [vision]
      summary: Analyze Gazebo camera image with GPT-4 Vision
      operationId: analyzeVisualScene
      description: |
        Sends robot camera image to GPT-4 Vision API for scene understanding.
        Returns object list with spatial relationships.
        Results cached for 30 seconds (scene changes slowly in simulation).
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [image]
              properties:
                image:
                  type: string
                  format: binary
                  description: JPEG image from Gazebo camera (<500KB)
                query:
                  type: string
                  maxLength: 200
                  example: "Describe what you see"
                  description: Optional custom query (default "list all objects")
                include_spatial_relations:
                  type: boolean
                  default: true
                  description: Include "left_of", "in_front_of" relationships
      responses:
        '200':
          description: Scene analysis successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VisualSceneResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalError'

  /robot/command:
    post:
      tags: [robot]
      summary: Convert natural language to robot action
      operationId: executeRobotCommand
      description: |
        Accepts natural language command, uses LLM to generate robot action,
        validates safety constraints, and executes if safe.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [command]
              properties:
                command:
                  type: string
                  maxLength: 500
                  example: "Move forward 2 meters and pick up the red cube"
                  description: Natural language robot command
                voice_command_id:
                  type: string
                  format: uuid
                  description: Link to voice command (if from speech)
                visual_scene_id:
                  type: string
                  format: uuid
                  description: Link to scene analysis (if using vision)
                robot_state:
                  $ref: '#/components/schemas/RobotState'
                  description: Current robot position/status
      responses:
        '200':
          description: Command processed (may be executed or rejected)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RobotCommandResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'
        '500':
          $ref: '#/components/responses/InternalError'

  /robot/actions/{action_id}/status:
    get:
      tags: [robot]
      summary: Get robot action execution status
      operationId: getActionStatus
      parameters:
        - name: action_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Action status retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RobotActionStatus'
        '404':
          description: Action not found

  /code/generate:
    post:
      tags: [code]
      summary: Generate ROS 2 code from natural language
      operationId: generateCode
      description: |
        Uses GPT-4 to generate executable ROS 2 Python code from description.
        Code is syntax-validated before returning.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [description]
              properties:
                description:
                  type: string
                  maxLength: 1000
                  example: "Create a publisher that sends Twist messages at 10 Hz"
                code_type:
                  type: string
                  enum: [node, launch_file, service, action]
                  default: node
                include_comments:
                  type: boolean
                  default: true
                include_error_handling:
                  type: boolean
                  default: true
      responses:
        '200':
          description: Code generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeneratedCodeResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'

  /code/debug:
    post:
      tags: [code]
      summary: Debug ROS 2 code with AI assistance
      operationId: debugCode
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [code, error_message]
              properties:
                code:
                  type: string
                  description: Python code with error
                error_message:
                  type: string
                  description: Exception/error text
      responses:
        '200':
          description: Debug assistance provided
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DebugResponse'

  /code/execute:
    post:
      tags: [code]
      summary: Execute ROS 2 code in sandbox
      operationId: executeCode
      description: |
        Runs user code in isolated Docker container with 30s timeout.
        Connects to live Gazebo simulation.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [code]
              properties:
                code:
                  type: string
                  description: Python code to execute
                timeout_seconds:
                  type: integer
                  minimum: 1
                  maximum: 30
                  default: 30
      responses:
        '200':
          description: Code executed (may have runtime errors)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CodeExecutionResponse'

  /capstone/project:
    get:
      tags: [capstone]
      summary: Get current capstone project status
      operationId: getCapstoneProject
      responses:
        '200':
          description: Project retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CapstoneProjectResponse'
        '404':
          description: No capstone project started yet

    post:
      tags: [capstone]
      summary: Start new capstone project
      operationId: startCapstoneProject
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                project_title:
                  type: string
                  maxLength: 200
                  default: "Autonomous Humanoid Assistant"
      responses:
        '201':
          description: Project created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CapstoneProjectResponse'
        '409':
          description: Project already exists (only 1 per user)

  /capstone/project/phases/{phase_number}/complete:
    post:
      tags: [capstone]
      summary: Mark capstone phase as complete
      operationId: completeCapstonePhase
      parameters:
        - name: phase_number
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
            maximum: 6
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [test_passed]
              properties:
                test_passed:
                  type: boolean
                  description: Did integration test pass?
                notes:
                  type: string
                  description: Optional completion notes
      responses:
        '200':
          description: Phase marked complete
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CapstoneProjectResponse'

  /playground/experiments:
    get:
      tags: [playground]
      summary: List user's saved experiments
      operationId: listExperiments
      responses:
        '200':
          description: Experiments retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PlaygroundExperiment'

    post:
      tags: [playground]
      summary: Create new playground experiment
      operationId: createExperiment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [experiment_name, system_prompt]
              properties:
                experiment_name:
                  type: string
                  maxLength: 200
                  example: "Cautious Navigation Test"
                system_prompt:
                  type: string
                  maxLength: 2000
                  example: "You are a very cautious robot..."
                parameter_settings:
                  $ref: '#/components/schemas/PlaygroundParameters'
                scenario_type:
                  type: string
                  enum: [navigation, manipulation, exploration]
      responses:
        '201':
          description: Experiment created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlaygroundExperiment'

  /playground/experiments/{experiment_id}/run:
    post:
      tags: [playground]
      summary: Run playground experiment with test command
      operationId: runExperiment
      parameters:
        - name: experiment_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [test_command]
              properties:
                test_command:
                  type: string
                  example: "Move forward 1 meter"
      responses:
        '200':
          description: Experiment run complete
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExperimentRunResponse'

  /playground/experiments/{experiment_id}/export:
    get:
      tags: [playground]
      summary: Export experiment as ROS 2 launch file
      operationId: exportExperiment
      parameters:
        - name: experiment_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Launch file generated
          content:
            text/plain:
              schema:
                type: string
                description: Python launch file content

components:
  schemas:
    TranscriptionResponse:
      type: object
      properties:
        voice_command_id:
          type: string
          format: uuid
        transcribed_text:
          type: string
        confidence_score:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
        language_detected:
          type: string
        processing_time_ms:
          type: integer

    VisualSceneResponse:
      type: object
      properties:
        scene_id:
          type: string
          format: uuid
        scene_description:
          type: string
          example: "I see a red cube 30cm to the left, a blue cylinder directly ahead..."
        detected_objects:
          type: array
          items:
            type: object
            properties:
              object_id:
                type: string
              label:
                type: string
              confidence:
                type: number
              position_description:
                type: string
              attributes:
                type: object
        spatial_relations:
          type: array
          items:
            type: object
            properties:
              obj1:
                type: string
              relation:
                type: string
                enum: [left_of, right_of, in_front_of, behind, above, below]
              obj2:
                type: string
        cached:
          type: boolean
          description: Was result from cache?

    RobotCommandResponse:
      type: object
      properties:
        llm_query_id:
          type: string
          format: uuid
        actions:
          type: array
          items:
            $ref: '#/components/schemas/RobotAction'
        safety_validated:
          type: boolean
        safety_notes:
          type: string
        clarification_needed:
          type: boolean
        clarification_question:
          type: string
          example: "Which red object? I see 3 red objects in the scene."

    RobotAction:
      type: object
      properties:
        action_id:
          type: string
          format: uuid
        action_type:
          type: string
          enum: [move, rotate, grasp, release, wait]
        parameters:
          type: object
        safety_validated:
          type: boolean
        execution_order:
          type: integer
        estimated_duration_seconds:
          type: number

    RobotActionStatus:
      type: object
      properties:
        action_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, validated, executing, completed, failed]
        progress_percentage:
          type: number
          minimum: 0
          maximum: 100
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        error_message:
          type: string

    RobotState:
      type: object
      properties:
        position:
          type: object
          properties:
            x:
              type: number
            y:
              type: number
            z:
              type: number
        orientation:
          type: object
          properties:
            roll:
              type: number
            pitch:
              type: number
            yaw:
              type: number
        gripper_state:
          type: string
          enum: [empty, holding]
        held_object:
          type: string
        battery_percentage:
          type: number
          minimum: 0
          maximum: 100
        nearest_obstacle_distance:
          type: number
        nearest_obstacle_direction:
          type: string

    GeneratedCodeResponse:
      type: object
      properties:
        code_id:
          type: string
          format: uuid
        generated_code:
          type: string
        language:
          type: string
        validation_errors:
          type: array
          items:
            type: object
            properties:
              line:
                type: integer
              error_type:
                type: string
              message:
                type: string
        explanation:
          type: string
          description: Brief explanation of what the code does

    DebugResponse:
      type: object
      properties:
        error_diagnosis:
          type: string
        suggested_fix:
          type: string
        corrected_code:
          type: string
        explanation:
          type: string

    CodeExecutionResponse:
      type: object
      properties:
        execution_id:
          type: string
          format: uuid
        success:
          type: boolean
        stdout:
          type: string
        stderr:
          type: string
        execution_time_ms:
          type: integer
        timeout_reached:
          type: boolean

    CapstoneProjectResponse:
      type: object
      properties:
        project_id:
          type: string
          format: uuid
        project_title:
          type: string
        current_phase:
          type: integer
        progress_percentage:
          type: number
        phases:
          type: array
          items:
            type: object
            properties:
              phase_number:
                type: integer
              phase_name:
                type: string
              status:
                type: string
                enum: [pending, in_progress, completed]
              test_passed:
                type: boolean
              completed_at:
                type: string
                format: date-time
        demo_ready:
          type: boolean
        created_at:
          type: string
          format: date-time

    PlaygroundExperiment:
      type: object
      properties:
        experiment_id:
          type: string
          format: uuid
        experiment_name:
          type: string
        system_prompt:
          type: string
        parameter_settings:
          $ref: '#/components/schemas/PlaygroundParameters'
        scenario_type:
          type: string
        run_count:
          type: integer
        last_run_at:
          type: string
          format: date-time

    PlaygroundParameters:
      type: object
      properties:
        llm_temperature:
          type: number
          minimum: 0.0
          maximum: 2.0
          default: 0.3
        safety_conservativeness:
          type: number
          minimum: 0.0
          maximum: 1.0
          default: 0.8
        max_speed_override:
          type: number
          minimum: 0.0
          maximum: 1.0
        verbose_reasoning:
          type: boolean
          default: true
        allow_replanning:
          type: boolean
          default: true

    ExperimentRunResponse:
      type: object
      properties:
        run_id:
          type: string
          format: uuid
        command_interpretation:
          type: string
        llm_reasoning:
          type: string
        generated_actions:
          type: array
          items:
            $ref: '#/components/schemas/RobotAction'
        safety_validation_result:
          type: object
          properties:
            validated:
              type: boolean
            notes:
              type: string

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: object
        request_id:
          type: string
          format: uuid

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

    RateLimitExceeded:
      description: OpenAI API rate limit exceeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: rate_limit_exceeded
            message: "OpenAI API rate limit reached. Please wait 60 seconds."
            details:
              retry_after_seconds: 60

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT from better-auth.com (inherited from Chapters 1-2)

security:
  - BearerAuth: []
